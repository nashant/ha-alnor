> **ü§ñ AI-Generated Code**: This entire integration was generated by [Claude Code](https://claude.com/claude-code).
> All code, documentation, tests, and CI/CD infrastructure were created through AI assistance.

# Alnor Ventilation for Home Assistant

[![GitHub Release][releases-shield]][releases]
[![GitHub Activity][commits-shield]][commits]
[![License][license-shield]](LICENSE)
[![hacs][hacsbadge]][hacs]
[![Project Maintenance][maintenance-shield]][user_profile]

**Control your Alnor ventilation devices with Home Assistant! üå¨Ô∏è**

A comprehensive Home Assistant integration for Alnor ventilation systems including Heat Recovery Units (HRU), exhaust fans, and environmental sensors. Get real-time monitoring, intelligent control, and seamless automation of your home ventilation.

**Features at a glance:**
- üîå **Dual-mode operation**: Cloud API + Local Modbus TCP for faster response
- üîç **Automatic discovery**: Finds all your devices instantly
- üè† **Area synchronization**: Maps devices to Home Assistant areas
- üìä **Comprehensive monitoring**: Temperature, humidity, CO2, fan speeds, and more
- üéõÔ∏è **Full control**: Speed, modes, schedules, and filter management
- ‚ö° **Offline capable**: Local Modbus connections work without internet

---

## Table of Contents

- [Supported Devices](#supported-devices)
- [Installation](#installation)
- [Configuration](#configuration)
- [Entities](#entities)
- [Usage Examples](#usage-examples)
- [Advanced Features](#advanced-features)
- [Troubleshooting](#troubleshooting)
- [Contributing](#contributing)
- [Support](#support)

---

## Supported Devices

### Heat Recovery Units (HRU) üåÄ

- **HRU-PremAir-450**
- **HRU-PremAir-500**

**Entities created:** 13 per device
- Fan control with speed and preset modes
- 9 sensors (temperatures, fan speeds, filter status, bypass, preheater)
- Fault detection
- Mode selection
- Filter reset button

### Exhaust Fans üí®

- **VMC-02VJ04**
- **VMC Exhaust Fan series**

**Entities created:** 4 per device
- Fan control with speed and modes
- Speed sensor
- Fault detection
- Mode selection

### Environmental Sensors üìä

- **VMS-02C05** (CO2 Sensor)
- **VMI-02MC02** (Humidity Sensor)

**Entities created:** 1-2 per sensor
- CO2 level (ppm)
- Temperature (¬∞C)
- Humidity (%)

---

## Installation

### HACS (Recommended)

1. **Open HACS** in Home Assistant
2. Go to **Integrations**
3. Click the **‚ãÆ** menu (top right) ‚Üí **Custom repositories**
4. Add repository URL:
   ```
   https://github.com/nashant/ha-alnor
   ```
   Category: **Integration**
5. Click **Download** on the Alnor Ventilation card
6. **Restart** Home Assistant
7. Go to **Settings** ‚Üí **Devices & Services** ‚Üí **Add Integration**
8. Search for **"Alnor Ventilation"**

### Manual Installation

1. Download the latest release from [GitHub Releases][releases]
2. Extract the `alnor` folder from the ZIP
3. Copy to your Home Assistant config directory:
   ```
   config/
   ‚îî‚îÄ‚îÄ custom_components/
       ‚îî‚îÄ‚îÄ alnor/
           ‚îú‚îÄ‚îÄ __init__.py
           ‚îú‚îÄ‚îÄ manifest.json
           ‚îî‚îÄ‚îÄ ...
   ```
4. **Restart** Home Assistant
5. Go to **Settings** ‚Üí **Devices & Services** ‚Üí **Add Integration**
6. Search for **"Alnor Ventilation"**

---

## Configuration

### Initial Setup

<details>
<summary><b>Step 1: Add Integration</b></summary>

1. Navigate to **Settings** ‚Üí **Devices & Services**
2. Click **+ Add Integration**
3. Search for **"Alnor Ventilation"**
4. Click on the integration

</details>

<details>
<summary><b>Step 2: Enter Credentials</b></summary>

Enter your Alnor cloud account credentials:

- **Email**: Your Alnor account email
- **Password**: Your Alnor account password
- **Sync zones** ‚úÖ (Optional): Automatically create Alnor zones matching your Home Assistant areas

![Configuration Step 1](https://via.placeholder.com/800x400/1e88e5/ffffff?text=Configuration+Screen)

</details>

<details>
<summary><b>Step 3: Automatic Discovery</b></summary>

The integration will automatically:
- ‚úÖ Connect to Alnor cloud
- ‚úÖ Discover all bridges (gateways)
- ‚úÖ Discover all connected devices
- ‚úÖ Create entities for each device
- ‚úÖ Assign devices to areas (if zones synced)

</details>

### Options (Optional)

After setup, configure advanced options:

1. Go to **Settings** ‚Üí **Devices & Services**
2. Find **Alnor Ventilation** card
3. Click **Configure**

#### Zone Synchronization

Toggle **"Synchronize zones with Home Assistant areas"** to:
- Automatically create Alnor zones matching your HA areas
- Keep area assignments in sync

#### Local Modbus TCP (Advanced)

Enable **"Configure local Modbus TCP connections"** for:
- ‚ö° Faster response times (< 100ms vs 1-2s)
- üîå Offline operation (works without internet)
- üìâ Lower cloud API usage

**Requirements:**
- Devices must be on the same network
- Port 502 must be accessible
- Know your device IP addresses

**Configuration:**
1. Select **"Configure local Modbus TCP connections"**
2. Enter IP address for each device (e.g., `192.168.1.100`)
3. Click **Submit**
4. Integration validates connection and falls back to cloud if needed

> [!TIP]
> Use static IP addresses or DHCP reservations for reliable local connections.

---

## Entities

### Heat Recovery Unit (HRU-PremAir-450/500)

#### Fan Control üéõÔ∏è

**Entity:** `fan.living_room_hru`

Controls the ventilation unit with:
- **Speed:** 0-100% slider
- **Preset Modes:**
  - `standby` - Minimal ventilation
  - `away` - Reduced ventilation when away
  - `home` - Standard home ventilation
  - `home_plus` - Enhanced ventilation
  - `auto` - Automatic based on sensors
  - `party` - Maximum ventilation for gatherings

#### Sensors üìä

| Sensor | Entity ID | Unit | Description |
|--------|-----------|------|-------------|
| Indoor Temperature | `sensor.living_room_hru_indoor_temperature` | ¬∞C | Inside air temperature |
| Outdoor Temperature | `sensor.living_room_hru_outdoor_temperature` | ¬∞C | Outside air temperature |
| Exhaust Temperature | `sensor.living_room_hru_exhaust_temperature` | ¬∞C | Outgoing air temperature |
| Supply Temperature | `sensor.living_room_hru_supply_temperature` | ¬∞C | Incoming air temperature |
| Exhaust Fan Speed | `sensor.living_room_hru_exhaust_fan_speed` | % | Exhaust fan current speed |
| Supply Fan Speed | `sensor.living_room_hru_supply_fan_speed` | % | Supply fan current speed |
| Filter Days Remaining | `sensor.living_room_hru_filter_days_remaining` | days | Days until filter replacement |
| Bypass Position | `sensor.living_room_hru_bypass_position` | % | Heat exchanger bypass valve |
| Preheater Demand | `sensor.living_room_hru_preheater_demand` | % | Electric preheater power |

#### Binary Sensor üö®

**Entity:** `binary_sensor.living_room_hru_fault`

- **State:** `on` = Fault detected, `off` = Normal operation
- **Attributes:** `fault_code` when fault is active

#### Select üîΩ

**Entity:** `select.living_room_hru_mode`

Alternative mode control (same options as fan preset modes)

#### Button üîò

**Entity:** `button.living_room_hru_reset_filter_timer`

Press to reset filter replacement countdown after changing filter

### Exhaust Fan (VMC-02VJ04)

#### Fan Control

**Entity:** `fan.bathroom_fan`

- **Speed:** 0-100%
- **Preset Modes:** Same as HRU

#### Sensors

- `sensor.bathroom_fan_speed` - Current fan speed (%)

#### Binary Sensor

- `binary_sensor.bathroom_fan_fault` - Fault detection

#### Select

- `select.bathroom_fan_mode` - Mode selection

### Environmental Sensors

#### CO2 Sensor (VMS-02C05)

**Entity:** `sensor.office_co2_sensor_co2_level`
- **Unit:** ppm (parts per million)
- **Device Class:** CO2

#### Humidity Sensor (VMI-02MC02)

**Entities:**
- `sensor.bedroom_humidity_sensor_temperature` - Temperature (¬∞C)
- `sensor.bedroom_humidity_sensor_humidity` - Relative humidity (%)

---

## Usage Examples

### Basic Automations

#### üå°Ô∏è Temperature-Based Ventilation

```yaml
automation:
  - alias: "Increase ventilation when hot"
    trigger:
      - platform: numeric_state
        entity_id: sensor.living_room_hru_indoor_temperature
        above: 25
    action:
      - service: fan.set_preset_mode
        target:
          entity_id: fan.living_room_hru
        data:
          preset_mode: "home_plus"
```

#### üí® CO2-Based Ventilation

```yaml
automation:
  - alias: "Boost ventilation on high CO2"
    trigger:
      - platform: numeric_state
        entity_id: sensor.office_co2_sensor_co2_level
        above: 1000
    action:
      - service: fan.set_preset_mode
        target:
          entity_id: fan.living_room_hru
        data:
          preset_mode: "party"
```

#### üèÉ Away Mode Automation

```yaml
automation:
  - alias: "Set ventilation to away mode"
    trigger:
      - platform: state
        entity_id: binary_sensor.home_occupied
        to: "off"
        for:
          minutes: 30
    action:
      - service: fan.set_preset_mode
        target:
          entity_id: fan.living_room_hru
        data:
          preset_mode: "away"
```

#### üîî Filter Replacement Reminder

```yaml
automation:
  - alias: "Filter replacement reminder"
    trigger:
      - platform: numeric_state
        entity_id: sensor.living_room_hru_filter_days_remaining
        below: 7
    action:
      - service: notify.mobile_app
        data:
          title: "HRU Filter Replacement"
          message: >
            Only {{ states('sensor.living_room_hru_filter_days_remaining') }}
            days remaining until filter replacement needed.
```

### Dashboard Cards

#### Lovelace Card Example

```yaml
type: entities
title: Living Room Ventilation
entities:
  - entity: fan.living_room_hru
    name: Ventilation Control
  - type: divider
  - entity: sensor.living_room_hru_indoor_temperature
    name: Indoor Temperature
  - entity: sensor.living_room_hru_outdoor_temperature
    name: Outdoor Temperature
  - entity: sensor.living_room_hru_supply_temperature
    name: Supply Temperature
  - type: divider
  - entity: sensor.living_room_hru_exhaust_fan_speed
    name: Exhaust Fan
  - entity: sensor.living_room_hru_supply_fan_speed
    name: Supply Fan
  - type: divider
  - entity: sensor.living_room_hru_filter_days_remaining
    name: Filter Status
  - entity: button.living_room_hru_reset_filter_timer
    name: Reset Filter Timer
```

#### Mushroom Cards (Modern UI)

```yaml
type: vertical-stack
cards:
  - type: custom:mushroom-fan-card
    entity: fan.living_room_hru
    icon: mdi:air-filter
    name: Ventilation
    show_percentage_control: true
    show_oscillate_control: false
    collapsible_controls: true

  - type: custom:mushroom-chips-card
    chips:
      - type: template
        entity: sensor.living_room_hru_indoor_temperature
        icon: mdi:thermometer
        content: "{{ states(entity) }}¬∞C"

      - type: template
        entity: sensor.living_room_hru_filter_days_remaining
        icon: mdi:air-filter
        content: "{{ states(entity) }}d"

      - type: template
        entity: binary_sensor.living_room_hru_fault
        icon: mdi:alert-circle
        icon_color: red
```

---

## Advanced Features

### üîå Dual-Mode Operation

The integration supports **both cloud API and local Modbus TCP**, providing:

| Mode | Latency | Offline | Setup |
|------|---------|---------|-------|
| **Cloud API** | 1-2 seconds | ‚ùå No | Automatic |
| **Local Modbus** | < 100ms | ‚úÖ Yes | Manual IP config |

**How it works:**
1. **Cloud API** is used by default for all devices (automatic discovery)
2. **Local Modbus** can be enabled per-device in options
3. Integration **automatically falls back** to cloud if local fails
4. Connection mode shown in entity attributes

**View connection mode:**
```yaml
{{ state_attr('fan.living_room_hru', 'connection_mode') }}
# Returns: 'local' or 'cloud'
```

### üè† Area Synchronization

When enabled, the integration:
1. Creates Alnor zones matching your Home Assistant areas
2. Automatically assigns discovered devices to correct areas
3. Keeps zone assignments synchronized

**Use case:** If you create a new area "Guest Bedroom" in Home Assistant, the integration creates a matching zone in Alnor cloud, allowing you to assign devices through either interface.

### üîÑ Update Intervals

- **Local connections:** 30 seconds
- **Cloud connections:** 60 seconds
- Automatically adjusts based on active connection modes

### üõ°Ô∏è Security

- Credentials encrypted by Home Assistant core
- OAuth tokens not persisted (re-authenticated on restart)
- Modbus connections local-only (no internet exposure)

---

## Troubleshooting

### Common Issues

<details>
<summary><b>Integration doesn't appear in Add Integration list</b></summary>

**Solution:**
1. Verify files are in `config/custom_components/alnor/`
2. Check logs for import errors: **Settings** ‚Üí **System** ‚Üí **Logs**
3. Restart Home Assistant
4. Clear browser cache (Ctrl+Shift+R)

</details>

<details>
<summary><b>Authentication failed</b></summary>

**Symptoms:** "Invalid email or password" error

**Solution:**
1. Verify credentials work in Alnor mobile app
2. Check for typos (email is case-sensitive)
3. Reset password if needed
4. Try re-adding integration

</details>

<details>
<summary><b>Devices not discovered</b></summary>

**Symptoms:** Integration sets up but no devices appear

**Solution:**
1. Verify devices appear in Alnor mobile app
2. Check bridge (gateway) is online
3. Reload integration: **‚ãÆ** menu ‚Üí **Reload**
4. Check logs for API errors

</details>

<details>
<summary><b>Local Modbus connection fails</b></summary>

**Symptoms:** "Cannot connect" error when configuring local IP

**Solution:**
1. **Verify IP address** is correct (check router DHCP table)
2. **Check network connectivity**: `ping <device_ip>` from HA server
3. **Firewall:** Ensure port 502 is open
4. **Network segmentation:** Devices must be on same network as HA
5. **Static IP:** Assign static IP or DHCP reservation

**Note:** Integration automatically falls back to cloud if local fails

</details>

<details>
<summary><b>Entities unavailable</b></summary>

**Symptoms:** Entities show as "Unavailable"

**Solution:**
1. **Check device status** in Alnor app (online/offline)
2. **Internet connection** required for cloud mode
3. **API issues**: Check [Alnor status page](#) (if available)
4. **Reload integration** to force reconnect
5. **Check logs** for specific error messages

</details>

<details>
<summary><b>Filter reset button doesn't work</b></summary>

**Symptom:** Button press has no effect

**Solution:**
1. Check if SDK supports `reset_filter_timer()` method
2. Verify in Alnor app that filter timer was reset
3. May require SDK update if feature not implemented
4. Workaround: Reset manually through Alnor app

</details>

### Debug Logging

Enable debug logging for troubleshooting:

```yaml
# configuration.yaml
logger:
  default: info
  logs:
    custom_components.alnor: debug
    alnor_sdk: debug
```

Then check logs: **Settings** ‚Üí **System** ‚Üí **Logs**

### Getting Help

- üìñ [Detailed Documentation](docs/)
- üêõ [Report a Bug][issues]
- üí¨ [Community Discussions][discussions]
- ‚ùì [FAQ](docs/FAQ.md)

---

## Contributing

Contributions are welcome! See [CONTRIBUTING.md](.github/CONTRIBUTING.md) for guidelines.

### Development Setup

```bash
# Clone repository
git clone https://github.com/nashant/ha-alnor.git
cd ha-alnor

# Install dependencies
pip install -r requirements_test.txt

# Install pre-commit hooks
pre-commit install

# Run tests
pytest

# Run linting
ruff check custom_components/
black custom_components/
isort custom_components/
```

### Commit Messages

This project uses [Conventional Commits](https://www.conventionalcommits.org/):

```bash
feat: add support for new device type
fix: correct temperature conversion
docs: update installation guide
```

See [CONTRIBUTING.md](.github/CONTRIBUTING.md) for details.

---

## Support

### Star the Project ‚≠ê

If you find this integration helpful, please give it a star on GitHub! It helps others discover the project and motivates continued development.

### Report Issues üêõ

Found a bug? Have a feature request? [Open an issue][issues]!

### Discussions üí¨

Have questions or want to share your setup? [Start a discussion][discussions]!

### Donations ‚òï

This is a passion project developed in my free time. If you'd like to support development:

[![Buy Me A Coffee][coffee-badge]][coffee]

---

## Credits

- **Developer:** [@nashant][user_profile]
- **Alnor SDK:** [alnor-sdk](https://github.com/nashant/alnor-sdk)
- **Inspired by:** [magic-areas](https://github.com/jseidl/magic-areas)

## License

This project is licensed under the MIT License - see [LICENSE](LICENSE) file for details.

---

<p align="center">Made with ‚ù§Ô∏è for the Home Assistant community</p>

---

[releases-shield]: https://img.shields.io/github/release/nashant/ha-alnor.svg?style=for-the-badge
[releases]: https://github.com/nashant/ha-alnor/releases
[commits-shield]: https://img.shields.io/github/commit-activity/y/nashant/ha-alnor.svg?style=for-the-badge
[commits]: https://github.com/nashant/ha-alnor/commits/main
[license-shield]: https://img.shields.io/github/license/nashant/ha-alnor.svg?style=for-the-badge
[hacsbadge]: https://img.shields.io/badge/HACS-Custom-orange.svg?style=for-the-badge
[hacs]: https://github.com/hacs/integration
[maintenance-shield]: https://img.shields.io/badge/maintainer-%40nashant-blue.svg?style=for-the-badge
[user_profile]: https://github.com/nashant
[coffee-badge]: https://img.shields.io/badge/Buy%20Me%20A%20Coffee-support-yellow.svg?style=for-the-badge
[coffee]: https://www.buymeacoffee.com/nashant
[issues]: https://github.com/nashant/ha-alnor/issues
[discussions]: https://github.com/nashant/ha-alnor/discussions
